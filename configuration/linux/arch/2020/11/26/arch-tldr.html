<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Automating provisioning Arch continued - TLDR | Ian’s Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Automating provisioning Arch continued - TLDR" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Summarizing how I provision my machines with just the steps to reproduce the process." />
<meta property="og:description" content="Summarizing how I provision my machines with just the steps to reproduce the process." />
<link rel="canonical" href="https://blog.ianpreston.ca/configuration/linux/arch/2020/11/26/arch-tldr.html" />
<meta property="og:url" content="https://blog.ianpreston.ca/configuration/linux/arch/2020/11/26/arch-tldr.html" />
<meta property="og:site_name" content="Ian’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-26T00:00:00-06:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.ianpreston.ca/configuration/linux/arch/2020/11/26/arch-tldr.html"},"url":"https://blog.ianpreston.ca/configuration/linux/arch/2020/11/26/arch-tldr.html","@type":"BlogPosting","headline":"Automating provisioning Arch continued - TLDR","dateModified":"2020-11-26T00:00:00-06:00","datePublished":"2020-11-26T00:00:00-06:00","description":"Summarizing how I provision my machines with just the steps to reproduce the process.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://blog.ianpreston.ca/feed.xml" title="Ian's Blog" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Ian&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Automating provisioning Arch continued - TLDR</h1><p class="page-description">Summarizing how I provision my machines with just the steps to reproduce the process.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-11-26T00:00:00-06:00" itemprop="datePublished">
        Nov 26, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#configuration">configuration</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#linux">linux</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#arch">arch</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#introduction">Introduction</a></li>
<li class="toc-entry toc-h1"><a href="#arch-usb-boot">Arch USB boot</a></li>
<li class="toc-entry toc-h1"><a href="#from-the-live-boot">From the live boot</a>
<ul>
<li class="toc-entry toc-h2"><a href="#setup-wifi">Setup WiFi</a></li>
<li class="toc-entry toc-h2"><a href="#make-sure-partitions-are-set-up">Make sure partitions are set up</a></li>
<li class="toc-entry toc-h2"><a href="#run-the-script">Run the script</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#set-up-ssh-keys">Set up ssh keys</a></li>
<li class="toc-entry toc-h1"><a href="#set-up-wifi-again">Set up WiFi again</a></li>
<li class="toc-entry toc-h1"><a href="#run-ansible">Run Ansible</a></li>
<li class="toc-entry toc-h1"><a href="#setup-dotfiles">Setup dotfiles</a></li>
<li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li>
</ul><h1 id="introduction">
<a class="anchor" href="#introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>This note is a reference for me to put together my full provisioning pipeline.</p>

<h1 id="arch-usb-boot">
<a class="anchor" href="#arch-usb-boot" aria-hidden="true"><span class="octicon octicon-link"></span></a>Arch USB boot</h1>

<p>Follow <a href="https://wiki.archlinux.org/index.php/USB_flash_installation_medium">The Arch guide</a></p>

<h1 id="from-the-live-boot">
<a class="anchor" href="#from-the-live-boot" aria-hidden="true"><span class="octicon octicon-link"></span></a>From the live boot</h1>

<h2 id="setup-wifi">
<a class="anchor" href="#setup-wifi" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup WiFi</h2>

<p>In the case where I’m doing this on a laptop I’ll likely have to get on WiFi before I can continue.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iwctl
station wlan0 connect &lt;your SSID&gt;  <span class="c"># You can enclose it in quotes if it has spaces</span>
&lt;enter passphrase&gt;
<span class="nb">exit
</span>dhcpcd wlan0
</code></pre></div></div>

<h2 id="make-sure-partitions-are-set-up">
<a class="anchor" href="#make-sure-partitions-are-set-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Make sure partitions are set up</h2>

<p>If you’re not just going to wipe the whole disk you can run <code class="language-plaintext highlighter-rouge">lsblk</code> to determine what partitions you have. <code class="language-plaintext highlighter-rouge">cfdisk</code> has a nice interface for creating and modifying partitions if necessary. To format the boot partition run:</p>

<p><code class="language-plaintext highlighter-rouge">mkfs.vfat -F32 /dev/&lt;partition&gt;</code></p>

<p><code class="language-plaintext highlighter-rouge">mkfs.ext4 /dev/&lt;partition&gt;</code> will work for the root partition.</p>

<h2 id="run-the-script">
<a class="anchor" href="#run-the-script" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run the script</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash &lt;<span class="o">(</span>curl <span class="nt">-fsSL</span> http://bootstrap.ianpreston.ca<span class="o">)</span>
</code></pre></div></div>

<p>After that power off, remove the USB and power back on.</p>

<h1 id="set-up-ssh-keys">
<a class="anchor" href="#set-up-ssh-keys" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set up ssh keys</h1>

<p>Plug in the USB with ssh keys on it. <a href="http://blog.ianpreston.ca/2020/05/03/ssh.html">Guide for reference</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsblk  <span class="c"># find where the partition with the keys is stored</span>
<span class="nb">mkdir </span>ssh  <span class="c"># make a mount point</span>
<span class="nb">sudo </span>mount /dev/sd&lt;something&gt; ssh
<span class="nb">cp</span> <span class="nt">-R</span> ssh ssh_local  <span class="c"># Have to set permissions on keys (stupid NTFS)</span>
<span class="nb">cd </span>ssh_local/CA
<span class="nb">chmod </span>600 host_ca
<span class="nb">chmod </span>600 user_ca
<span class="nb">cd</span> ../
<span class="nb">chmod</span> +x setup_host.sh
<span class="nb">chmod</span> +x setup_user.sh
<span class="nb">sudo</span> ./setup_host.sh
./setup_user.sh
</code></pre></div></div>

<h1 id="set-up-wifi-again">
<a class="anchor" href="#set-up-wifi-again" aria-hidden="true"><span class="octicon octicon-link"></span></a>Set up WiFi again</h1>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmcli device wifi connect &lt;SSID&gt; password &lt;password&gt;
</code></pre></div></div>

<h1 id="run-ansible">
<a class="anchor" href="#run-ansible" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run Ansible</h1>

<p>The bootstrap script cloned the repository into <code class="language-plaintext highlighter-rouge">/srv/recipes</code>. Modify the hosts file in <code class="language-plaintext highlighter-rouge">/srv/recipes/ansible/inventor/hosts</code> to include the hostname of the machine you’re setting up in the appropriate categories if you haven’t already.</p>

<p>Run <code class="language-plaintext highlighter-rouge">provision_desktop.sh</code> in the ansible folder. It will fail part way through as you won’t have the keys set up for GitHub for your local user. Go through the ssh key generation process again for the newly created user, this will also make a GitHub specific key. Manually add that key to GitHub’s authorized keys and re-run the recipe. I’ve also seen it flake out a few times on particular application installs. Often I can just get past it by running <code class="language-plaintext highlighter-rouge">yay -S &lt;application&gt;</code> to manually install the problematic app. At the time of this writing there’s an additional fix required for spotify that’s mentioned on the AUR page for it. I’m not putting that in the recipe as I’m hoping it will be fixed soon.</p>

<h1 id="setup-dotfiles">
<a class="anchor" href="#setup-dotfiles" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup dotfiles</h1>

<p>Log in as your regular user.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/.dotfiles
./setup.sh
rcup <span class="nt">-v</span>
</code></pre></div></div>

<h1 id="conclusion">
<a class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h1>

<p>Sure, you could just install Ubuntu and be done with it, but where’s the fun in that? Why not spend weeks yak shaving your setup until you’re perfectly happy with it?</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="ianepreston/iblog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/configuration/linux/arch/2020/11/26/arch-tldr.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>My blog. Mostly about data, python, and Linux.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/ianepreston" title="ianepreston"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/iPrestonBC" title="iPrestonBC"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

<h1 id="how-to-work-with-conda-environments-in-shell-scripts-and-makefiles">How to work with conda environments in shell scripts and Makefiles</h1>

<ol id="markdown-toc">
  <li><a href="#how-to-work-with-conda-environments-in-shell-scripts-and-makefiles" id="markdown-toc-how-to-work-with-conda-environments-in-shell-scripts-and-makefiles">How to work with conda environments in shell scripts and Makefiles</a>    <ol>
      <li><a href="#setting-up-the-problem" id="markdown-toc-setting-up-the-problem">Setting up the problem</a></li>
      <li><a href="#whats-going-on" id="markdown-toc-whats-going-on">What’s going on?</a></li>
      <li><a href="#possible-solution" id="markdown-toc-possible-solution">Possible solution</a></li>
      <li><a href="#possible-problem-and-solution" id="markdown-toc-possible-problem-and-solution">Possible problem and solution</a></li>
      <li><a href="#ok-how-about-makefiles" id="markdown-toc-ok-how-about-makefiles">Ok, how about MakeFiles?</a></li>
      <li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></li>
      <li><a href="#the-final-scripts" id="markdown-toc-the-final-scripts">The final scripts</a>        <ol>
          <li><a href="#makefile" id="markdown-toc-makefile">Makefile</a></li>
          <li><a href="#envyml" id="markdown-toc-envyml">env.yml</a></li>
          <li><a href="#egpy" id="markdown-toc-egpy">eg.py</a></li>
          <li><a href="#egsh-for-makefile" id="markdown-toc-egsh-for-makefile">eg.sh (for makefile)</a></li>
          <li><a href="#egsh-standalone" id="markdown-toc-egsh-standalone">eg.sh (standalone)</a></li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<p>I’ve struggled with automating working with the <code class="language-plaintext highlighter-rouge">conda</code> python environment manager for a while. It’s a relatively small part of my work flow so I haven’t made figuring it out a top priority, but it’s really bugging me. In this post I’m going to document the problem and all the troubleshooting steps I went through to resolve it. I’m writing this post in parallel with actually resolving the issue, so it’s going to be a bit stream of consciousness.</p>

<h2 id="setting-up-the-problem">Setting up the problem</h2>

<p>I have conda installed. I’m using bash as my shell. I’ve run <code class="language-plaintext highlighter-rouge">conda init bash</code> and my version of conda is new enough that this works nicely in interactive mode.</p>

<p>Before I go further describing the problem, I should note which version of conda I’m running, since I know a lot has changed with how it sets itself up, and more may change in the future. This guide is built using Miniconda on Windows 10, running <code class="language-plaintext highlighter-rouge">conda 4.8.3</code>.</p>

<p>When I open a new bash terminal I can see from my prompt that I’m in the <code class="language-plaintext highlighter-rouge">base</code> environment and I can run <code class="language-plaintext highlighter-rouge">conda activate example_env</code> to activate to activate an environment called <code class="language-plaintext highlighter-rouge">eg_env</code>. I can get back to <code class="language-plaintext highlighter-rouge">base</code> with <code class="language-plaintext highlighter-rouge">conda deactivate</code>. Now let’s say I’ve written a python script that’s intended to be run in that environment. I might want to write a shell script to run that file, or use a Makefile to use that script as part of a larger pipeline. To demo and work through this I’m going to make a small conda environment, and a small python script that will only work if I’m in that python environment.</p>

<p>Here’s my <code class="language-plaintext highlighter-rouge">env.yml</code>:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">eg_env</span>
<span class="na">dependencies</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">numpy</span>
</code></pre></div></div>

<p>Now I create a simple python script, which I should be able to run without issue from that environment, but not from base (I’m using Miniconda so my base env is quite sparse).</p>

<p>Here’s the <code class="language-plaintext highlighter-rouge">eg.py</code> file:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">__version__</span><span class="p">)</span>
</code></pre></div></div>

<p>Just to be sure I’ll try running it from base. I get the following error:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python eg.py
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"eg.py"</span>, line 1, <span class="k">in</span> &lt;module&gt;
    import numpy as np
ModuleNotFoundError: No module named <span class="s1">'numpy'</span>
</code></pre></div></div>

<p>Running it from my active environment is no problem:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python eg.py
1.18.1
</code></pre></div></div>

<p>Excellent, environment management works! But what if I want to call this from another scripts? This is clearly contrived in this example but there are certainly situations where I might want to do this, and if nothing else it will demonstrate a bit more about how conda works.</p>

<p>So first off, here’s a bash script that just runs the python program:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"This is my test bash script"</span>
python eg.py
</code></pre></div></div>

<p>If I run this script from my base environment, it behaves basically the same as before:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./eg.sh
This is my <span class="nb">test </span>bash script
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"eg.py"</span>, line 1, <span class="k">in</span> &lt;module&gt;
    import numpy as np
ModuleNotFoundError: No module named <span class="s1">'numpy'</span>
</code></pre></div></div>

<p>Similarly, if I run it from my example environment it runs just fine:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./eg.sh
This is my <span class="nb">test </span>bash script
1.18.1
</code></pre></div></div>

<p>Cool. OK, but say I want my script to handle activating the environment for me? Let’s modify it and see what happens:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"This is my test bash script"</span>
<span class="nb">echo</span> <span class="s2">"Activating conda environment"</span>
conda activate eg_env
<span class="nb">echo</span> <span class="s2">"Running python script"</span>
python eg.py
</code></pre></div></div>

<p>Running this from my base environment I get:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./eg.sh
This is my <span class="nb">test </span>bash script
Activating conda environment

CommandNotFoundError: Your shell has not been properly configured to use <span class="s1">'conda activate'</span><span class="nb">.</span>
<span class="nb">.</span>
<span class="nb">.</span>
<span class="nb">.</span>
Running python script
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"eg.py"</span>, line 1, <span class="k">in</span> &lt;module&gt;
    import numpy as np
ModuleNotFoundError: No module named <span class="s1">'numpy'</span>

</code></pre></div></div>

<h2 id="whats-going-on">What’s going on?</h2>

<p>There’s actually some guidance in the full error message from the attempt above. The relevant section is this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CommandNotFoundError: Your shell has not been properly configured to use <span class="s1">'conda activate'</span><span class="nb">.</span>

To initialize your shell, run

    <span class="nv">$ </span>conda init &lt;SHELL_NAME&gt;
</code></pre></div></div>

<p>I’ve already done that for my shell, but apparently it doesn’t apply to subshells launched from that shell. I can’t just put <code class="language-plaintext highlighter-rouge">conda init bash</code> in the script, because you need to restart your shell for it to be applied.</p>

<p>As far as I know, all running <code class="language-plaintext highlighter-rouge">conda init bash</code> did for me was add a line to my <code class="language-plaintext highlighter-rouge">.bash_profile</code> file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span>
<span class="c"># !! Contents within this block are managed by 'conda init' !!</span>
<span class="nb">eval</span> <span class="s2">"</span><span class="si">$(</span><span class="s1">'/C/ProgramData/Miniconda3/Scripts/conda.exe'</span> <span class="s1">'shell.bash'</span> <span class="s1">'hook'</span><span class="si">)</span><span class="s2">"</span>
<span class="c"># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span>
</code></pre></div></div>

<h2 id="possible-solution">Possible solution</h2>

<p>What happens if I just put that at the top of the script?</p>

<p>Bash script updated:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"This is my test bash script"</span>
<span class="nb">echo</span> <span class="s2">"Activating conda environment"</span>
<span class="nb">eval</span> <span class="s2">"</span><span class="si">$(</span><span class="s1">'/C/ProgramData/Miniconda3/Scripts/conda.exe'</span> <span class="s1">'shell.bash'</span> <span class="s1">'hook'</span><span class="si">)</span><span class="s2">"</span>
conda activate eg_env
<span class="nb">echo</span> <span class="s2">"Running python script"</span>
python eg.py
</code></pre></div></div>

<p>Output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./eg.sh
This is my <span class="nb">test </span>bash script
Activating conda environment
Running python script
1.18.1
</code></pre></div></div>

<p>It worked! Notably, I’m still in my base environment when the script exits. The activation only happens in the subshell. I also tested running this script from a prompt that was already in that environment and it ran fine as well.</p>

<h2 id="possible-problem-and-solution">Possible problem and solution</h2>

<p>Ok, this works as long as I’m either the only person trying to use this script, or everyone else is also running Miniconda on Windows from a system level install. That seems pretty fragile. Can we improve this?</p>

<p>The <code class="language-plaintext highlighter-rouge">which conda</code> command returns the path to your conda install, so I should be able to replace the absolute path with what that returns to get the same result:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"This is my test bash script"</span>
<span class="nb">echo</span> <span class="s2">"Activating conda environment"</span>
<span class="nb">eval</span> <span class="s2">"</span><span class="si">$($(</span>which conda<span class="si">)</span> <span class="s1">'shell.bash'</span> <span class="s1">'hook'</span><span class="si">)</span><span class="s2">"</span>
conda activate eg_env
<span class="nb">echo</span> <span class="s2">"Running python script"</span>
python eg.py
</code></pre></div></div>

<p>This works too! Getting pretty close to a nice solution.</p>

<h2 id="ok-how-about-makefiles">Ok, how about MakeFiles?</h2>

<p>Because I am fancy, I like to have a MakeFile for my projects, which I can then use to run scripts or series of commands with nice convenient shortcuts. Most of what I do could definitely be accomplished with pure shell scripting, but it will be a little nicer if I can do it with Make, so let’s try.</p>

<p>To make this a little more realistic I’m going to say there are two things I might want to do using <code class="language-plaintext highlighter-rouge">make</code> in this project. One might be to format the python file with <code class="language-plaintext highlighter-rouge">black</code> and the other might be to run the file. I’ll add <code class="language-plaintext highlighter-rouge">black</code> to my example environment, but not my base, which means I’ll have to have the environment activated to format or run the script. I’d like to be able to run the python script directly from the makefile, or run it through a shell script.</p>

<p>In the same folder as my example python and shell scripts I’ll add a <code class="language-plaintext highlighter-rouge">Makefile</code>, based off the top answer on <a href="https://stackoverflow.com/questions/53382383/makefile-cant-use-conda-activate">This stackoverflow question</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Oneshell means I can run multiple lines in a recipe in the same shell, so I don't have to</span>
<span class="c"># chain commands together with semicolon</span>
.ONESHELL:
<span class="c"># Need to specify bash in order for conda activate to work.</span>
<span class="nv">SHELL</span><span class="o">=</span>/bin/bash
<span class="c"># Note that the extra activate is needed to ensure that the activate floats env to the front of PATH</span>
<span class="nv">CONDA_ACTIVATE</span><span class="o">=</span><span class="nb">source</span> <span class="nv">$$</span><span class="o">(</span>conda info <span class="nt">--base</span><span class="o">)</span>/etc/profile.d/conda.sh <span class="p">;</span> conda activate <span class="p">;</span> conda activate

<span class="nb">test</span>:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    <span class="nb">echo</span> <span class="nv">$$</span><span class="o">(</span>which python<span class="o">)</span>

<span class="c"># format the file with black</span>
lint:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    black eg.py

<span class="c"># Run the file directly</span>
run_py:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    python eg.py

<span class="c"># Run the file from a shell script</span>
run_sh:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    bash eg.sh
</code></pre></div></div>

<p>I’m also going to update <code class="language-plaintext highlighter-rouge">eg.sh</code> to remove the environment activation I set up earlier, because the idea is that <code class="language-plaintext highlighter-rouge">make</code> should be handling this for me now.</p>

<p>All of these work! I’m a little bummed I have to put that <code class="language-plaintext highlighter-rouge">$(CONDA_ACTIVATE) eg_env</code> at the top of each recipe, but that’s still pretty solid. I tried adding an <code class="language-plaintext highlighter-rouge">active</code> recipe and setting it as a requirement for the other recipes like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>active:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env

<span class="nb">test</span>: active
    <span class="nb">echo</span> <span class="nv">$$</span><span class="o">(</span>which python<span class="o">)</span>
</code></pre></div></div>

<p>But the activation from <code class="language-plaintext highlighter-rouge">active</code> didn’t persist into running <code class="language-plaintext highlighter-rouge">test</code>. Maybe there’s a way to get that working but I’m going to call this close enough for my needs.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Getting conda activation to work from within bash and Makefiles is a finicky process. Or at least I don’t have a strong enough understanding of subshells, environment variables conda and probably some other things to make it seem otherwise. That said, the steps outlined in this guide should allow you to automate processes involving conda environments without too much hassle.</p>

<h2 id="the-final-scripts">The final scripts</h2>

<p>For reference, here’s the final form of what I used to setup and test this demo:</p>

<h3 id="makefile">Makefile</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Oneshell means I can run multiple lines in a recipe in the same shell, so I don't have to</span>
<span class="c"># chain commands together with semicolon</span>
.ONESHELL:
<span class="c"># Need to specify bash in order for conda activate to work.</span>
<span class="nv">SHELL</span><span class="o">=</span>/bin/bash
<span class="c"># Note that the extra activate is needed to ensure that the activate floats env to the front of PATH</span>
<span class="nv">CONDA_ACTIVATE</span><span class="o">=</span><span class="nb">source</span> <span class="nv">$$</span><span class="o">(</span>conda info <span class="nt">--base</span><span class="o">)</span>/etc/profile.d/conda.sh <span class="p">;</span> conda activate <span class="p">;</span> conda activate

<span class="nb">test</span>:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    <span class="nb">echo</span> <span class="nv">$$</span><span class="o">(</span>which python<span class="o">)</span>

<span class="c"># format the file with black</span>
lint:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    black eg.py

<span class="c"># Run the file directly</span>
run_py:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    python eg.py

<span class="c"># Run the file from a shell script</span>
run_sh:
    <span class="si">$(</span>CONDA_ACTIVATE<span class="si">)</span> eg_env
    bash eg.sh
</code></pre></div></div>

<h3 id="envyml">env.yml</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">eg_env</span>
<span class="na">dependencies</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">numpy</span>
    <span class="pi">-</span> <span class="s">black</span>
</code></pre></div></div>

<h3 id="egpy">eg.py</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">__version__</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="egsh-for-makefile">eg.sh (for makefile)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"This is my test bash script"</span>
<span class="nb">echo</span> <span class="s2">"Running python script"</span>
python eg.py
</code></pre></div></div>

<h3 id="egsh-standalone">eg.sh (standalone)</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"This is my test bash script"</span>
<span class="nb">echo</span> <span class="s2">"Activating conda environment"</span>
<span class="nb">eval</span> <span class="s2">"</span><span class="si">$($(</span>which conda<span class="si">)</span> <span class="s1">'shell.bash'</span> <span class="s1">'hook'</span><span class="si">)</span><span class="s2">"</span>
conda activate eg_env
<span class="nb">echo</span> <span class="s2">"Running python script"</span>
python eg.py
</code></pre></div></div>
